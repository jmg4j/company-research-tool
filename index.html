<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Company Research Tool</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh; padding: 20px;
        }
        .container {
            max-width: 1000px; margin: 0 auto; background: white;
            border-radius: 16px; box-shadow: 0 20px 40px rgba(0,0,0,0.1); overflow: hidden;
        }
        .header {
            background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
            color: white; padding: 40px; text-align: center;
        }
        .header h1 { font-size: 2.5em; margin-bottom: 10px; font-weight: 700; }
        .header p { font-size: 1.2em; opacity: 0.9; }
        .main-content { padding: 40px; }
        .section { margin-bottom: 40px; }
        .section h2 {
            font-size: 1.8em; margin-bottom: 20px; color: #1f2937;
            border-bottom: 3px solid #4f46e5; padding-bottom: 10px;
        }
        .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 25px; }
        .form-group { display: flex; flex-direction: column; }
        .form-group label { font-weight: 600; margin-bottom: 8px; color: #374151; }
        .form-group input, .form-group select {
            padding: 12px 16px; border: 2px solid #e5e7eb; border-radius: 8px;
            font-size: 16px; background: white;
        }
        .upload-section {
            border: 3px dashed #d1d5db; border-radius: 12px; padding: 40px;
            text-align: center; background: #f9fafb; cursor: pointer;
        }
        .upload-section:hover { border-color: #4f46e5; background: #f3f4f6; }
        .file-info {
            margin-top: 20px; padding: 16px; background: #ecfdf5;
            border: 2px solid #10b981; border-radius: 8px; color: #065f46;
        }
        .process-btn {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white; padding: 16px 32px; border: none; border-radius: 12px;
            font-size: 1.1em; cursor: pointer; width: 100%; margin-top: 30px;
        }
        .process-btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .status { margin-top: 20px; padding: 16px; border-radius: 8px; display: none; }
        .status.success { background: #ecfdf5; border: 2px solid #10b981; color: #065f46; }
        .status.error { background: #fef2f2; border: 2px solid #ef4444; color: #991b1b; }
        .status.processing { background: #fffbeb; border: 2px solid #f59e0b; color: #92400e; }
        .quick-btn { background: #4f46e5; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; margin: 5px; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üîç Company Research Tool</h1>
            <p>Automated competitive intelligence research powered by AI</p>
        </div>
        <div class="main-content">
            <div style="background: #fef3c7; border: 2px solid #f59e0b; color: #92400e; padding: 16px; border-radius: 8px; margin-bottom: 20px;">
                <strong>‚ö†Ô∏è Important:</strong> Upload max 20 companies. API costs covered - use responsibly!
            </div>
            
            <div class="section">
                <h2>‚öôÔ∏è Configuration</h2>
                <div class="form-grid">
                    <div class="form-group">
                        <label for="outputFileName">Output File Name</label>
                        <input type="text" id="outputFileName" value="research_results">
                    </div>
                </div>
            </div>

            <div class="section">
                <h2>‚òëÔ∏è Select Data Fields</h2>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px;">
                    <label style="display: flex; align-items: center; margin: 5px 0; cursor: pointer;">
                        <input type="checkbox" id="include_company_name" checked disabled style="margin-right: 8px;">
                        <span>Company Name</span>
                    </label>
                    <label style="display: flex; align-items: center; margin: 5px 0; cursor: pointer;">
                        <input type="checkbox" id="include_company_type" checked style="margin-right: 8px;">
                        <span>Company Type</span>
                    </label>
                    <label style="display: flex; align-items: center; margin: 5px 0; cursor: pointer;">
                        <input type="checkbox" id="include_location" checked style="margin-right: 8px;">
                        <span>Location</span>
                    </label>
                    <label style="display: flex; align-items: center; margin: 5px 0; cursor: pointer;">
                        <input type="checkbox" id="include_region" checked style="margin-right: 8px;">
                        <span>Region</span>
                    </label>
                    <label style="display: flex; align-items: center; margin: 5px 0; cursor: pointer;">
                        <input type="checkbox" id="include_total_headcount" checked style="margin-right: 8px;">
                        <span>Total Headcount</span>
                    </label>
                    <label style="display: flex; align-items: center; margin: 5px 0; cursor: pointer;">
                        <input type="checkbox" id="include_revenue" checked style="margin-right: 8px;">
                        <span>Revenue</span>
                    </label>
                    <label style="display: flex; align-items: center; margin: 5px 0; cursor: pointer;">
                        <input type="checkbox" id="include_glassdoor_rating" checked style="margin-right: 8px;">
                        <span>Glassdoor Rating</span>
                    </label>
                </div>
                <div style="margin-top: 15px;">
                    <button onclick="selectAllFields()" class="quick-btn">‚úÖ All</button>
                    <button onclick="selectEssentialFields()" class="quick-btn">üéØ Essential</button>
                </div>
            </div>

            <div class="section">
                <h2>üìÑ Upload Companies</h2>
                <div class="upload-section" id="uploadSection" onclick="document.getElementById('fileInput').click()">
                    <div style="font-size: 3em; margin-bottom: 16px;">üìä</div>
                    <div style="font-size: 1.2em; color: #6b7280; margin-bottom: 16px;">
                        Click to upload CSV/Excel file
                    </div>
                    <input type="file" id="fileInput" accept=".csv,.xlsx,.xls" style="display: none;">
                </div>
                <div id="fileInfo" class="file-info" style="display: none;"></div>
            </div>

            <button id="processBtn" class="process-btn" disabled>üöÄ Start Research</button>
            <div id="status" class="status"><div id="statusText"></div></div>
            <div id="resultsSection" style="margin-top: 30px; display: none;">
                <h2>‚úÖ Complete!</h2>
                <a id="downloadBtn" style="background: #7c3aed; color: white; padding: 14px 28px; border-radius: 10px; text-decoration: none; display: inline-block; margin-top: 10px;">üì• Download</a>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script>
function selectAllFields() {
            document.querySelectorAll('input[type="checkbox"][id^="include_"]:not([disabled])').forEach(cb => cb.checked = true);
        }

        function selectEssentialFields() {
            document.querySelectorAll('input[type="checkbox"][id^="include_"]:not([disabled])').forEach(cb => cb.checked = false);
            ['company_name', 'company_type', 'location', 'revenue', 'glassdoor_rating'].forEach(field => {
                const checkbox = document.getElementById(`include_${field}`);
                if (checkbox) checkbox.checked = true;
            });
        }

        class CompanyResearcher {
            constructor() {
                this.companies = [];
                this.results = [];
                this.isProcessing = false;
                this.initializeEventListeners();
            }

            initializeEventListeners() {
                document.getElementById('fileInput').addEventListener('change', this.handleFileSelect.bind(this));
                document.getElementById('processBtn').addEventListener('click', this.startResearch.bind(this));
            }

            handleFileSelect(e) {
                const file = e.target.files[0];
                if (file) this.processFile(file);
            }

            async processFile(file) {
                try {
                    const companies = await this.parseFile(file);
                    if (companies.length > 20) {
                        this.showStatus('error', '‚ùå Too many companies! Limit to 20.');
                        return;
                    }
                    this.companies = companies;
                    document.getElementById('fileInfo').style.display = 'block';
                    document.getElementById('fileInfo').innerHTML = `
                        <strong>‚úÖ Success!</strong><br>
                        Found ${companies.length} companies: ${companies.slice(0, 5).join(', ')}${companies.length > 5 ? '...' : ''}
                    `;
                    document.getElementById('processBtn').disabled = false;
                } catch (error) {
                    this.showStatus('error', `‚ùå Error: ${error.message}`);
                }
            }

            async parseFile(file) {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        try {
                            const data = new Uint8Array(e.target.result);
                            const workbook = XLSX.read(data, { type: 'array' });
                            const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                            const jsonData = XLSX.utils.sheet_to_json(firstSheet, { header: 1 });
                            const companies = jsonData.slice(1)
                                .map(row => row[0])
                                .filter(company => company && typeof company === 'string')
                                .map(company => company.trim());
                            resolve(companies);
                        } catch (error) {
                            reject(error);
                        }
                    };
                    reader.onerror = () => reject(new Error('Failed to read file'));
                    reader.readAsArrayBuffer(file);
                });
            }

            async startResearch() {
                if (this.isProcessing) return;
                this.isProcessing = true;
                this.results = [];
                document.getElementById('processBtn').disabled = true;
                document.getElementById('resultsSection').style.display = 'none';
                this.showStatus('processing', `üîç Researching ${this.companies.length} companies...`);

                for (let i = 0; i < this.companies.length; i++) {
                    const company = this.companies[i];
                    try {
                        const result = await this.researchCompany(company);
                        this.results.push(result);
                        this.showStatus('processing', `‚úÖ ${company} complete (${i + 1}/${this.companies.length})`);
                        if (i < this.companies.length - 1) {
                            await new Promise(resolve => setTimeout(resolve, 3000));
                        }
                    } catch (error) {
                        console.error(`Error researching ${company}:`, error);
                        this.results.push(this.createErrorResult(company, error.message));
                    }
                }
                this.completeResearch();
            }

            async researchCompany(companyName) {
                const systemPrompt = `You are a competitive intelligence analyst. Research companies using web search.

CRITICAL: You MUST use web search extensively. Search Glassdoor, LinkedIn, company websites, etc.

MANDATORY: NEVER use -1, "Unknown", or leave fields blank. ALWAYS estimate.

Return JSON with this EXACT structure:
{
  "company_name": "string",
  "location": "US state only",
  "company_type": "Public|Private|Startup|Nonprofit|Unknown",
  "region": "East|Midwest|West|Southern|International|Unknown",
  "total_headcount": integer,
  "revenue": integer,
  "glassdoor_rating": number,
  "research_summary": "what you found and sources",
  "sources_found": integer,
  "data_quality": "High|Medium|Low"
}`;

                const userPrompt = `Research this company: ${companyName}

Use multiple web searches. Find actual data. Estimate when needed.`;

                const response = await fetch('/.netlify/functions/research', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        messages: [
                            { role: 'system', content: systemPrompt },
                            { role: 'user', content: userPrompt }
                        ],
                        model: 'sonar-reasoning-pro'
                    })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(`API failed: ${response.status} - ${errorData.error || 'Unknown'}`);
                }

                const data = await response.json();
                console.log('API Response:', data);
                return this.parseApiResponse(data, companyName);
            }

            parseApiResponse(apiData, companyName) {
                try {
                    if (!apiData.choices || !apiData.choices[0]) {
                        throw new Error('Invalid API response structure');
                    }
                    const content = apiData.choices[0].message.content.trim();
                    const jsonStart = content.indexOf('{');
                    const jsonEnd = content.lastIndexOf('}') + 1;
                    
                    if (jsonStart === -1 || jsonEnd <= jsonStart) {
                        throw new Error('No valid JSON found');
                    }
                    
                    const jsonStr = content.substring(jsonStart, jsonEnd);
                    const data = JSON.parse(jsonStr);
                    return this.validateData(data, companyName);
                } catch (error) {
                    throw new Error(`Parse failed: ${error.message}`);
                }
            }

            validateData(data, companyName) {
                return {
                    company_name: data.company_name || companyName,
                    location: data.location || 'Unknown',
                    company_type: data.company_type || 'Unknown',
                    region: this.mapRegion(data.location),
                    total_headcount: Math.max(1, parseInt(data.total_headcount) || 1),
                    revenue: Math.max(1, parseInt(data.revenue) || 1),
                    glassdoor_rating: Math.max(1, Math.min(5, parseFloat(data.glassdoor_rating) || 3)),
                    research_summary: data.research_summary || 'Basic research completed',
                    sources_found: Math.max(0, parseInt(data.sources_found) || 0),
                    data_quality: data.data_quality || 'Medium'
                };
            }

            mapRegion(location) {
                if (!location) return 'Unknown';
                const regions = {
                    'East': ['CT', 'DE', 'ME', 'MA', 'NH', 'NJ', 'NY', 'VT'],
                    'Midwest': ['IL', 'IN', 'IA', 'KS', 'MI', 'MN', 'OH', 'WI'],
                    'West': ['CA', 'WA', 'OR', 'CO', 'AZ', 'NV', 'UT'],
                    'Southern': ['TX', 'FL', 'GA', 'NC', 'VA', 'TN', 'SC']
                };
                for (const [region, states] of Object.entries(regions)) {
                    if (states.some(state => location.includes(state))) return region;
                }
                return 'Unknown';
            }

            createErrorResult(companyName, errorMsg) {
                return {
                    company_name: companyName,
                    location: 'Unknown',
                    company_type: 'Unknown',
                    region: 'Unknown',
                    total_headcount: 1,
                    revenue: 1,
                    glassdoor_rating: 3,
                    research_summary: `Failed: ${errorMsg}`,
                    sources_found: 0,
                    data_quality: 'Low'
                };
            }

            completeResearch() {
                this.isProcessing = false;
                document.getElementById('processBtn').disabled = false;
                this.showStatus('success', '‚úÖ Research completed!');

                const csv = this.generateCSV();
                const blob = new Blob([csv], { type: 'text/csv' });
                const url = URL.createObjectURL(blob);
                
                const fileName = document.getElementById('outputFileName').value.trim() || 'research_results';
                const dateStamp = new Date().toISOString().split('T')[0];
                const finalFileName = `${fileName}_${dateStamp}.csv`;
                
                const downloadBtn = document.getElementById('downloadBtn');
                downloadBtn.href = url;
                downloadBtn.download = finalFileName;
                downloadBtn.innerHTML = `üì• Download ${finalFileName}`;
                
                document.getElementById('resultsSection').style.display = 'block';
            }

            generateCSV() {
                const selectedFields = this.getSelectedFields();
                const fieldMapping = {
                    'company_name': 'Company Name',
                    'company_type': 'Company Type',
                    'location': 'Location',
                    'region': 'Region',
                    'total_headcount': 'Total Headcount',
                    'revenue': 'Revenue',
                    'glassdoor_rating': 'Glassdoor Rating'
                };

                const headers = selectedFields.map(field => fieldMapping[field]);
                const rows = this.results.map(result => {
                    return selectedFields.map(field => {
                        const value = result[field];
                        return typeof value === 'string' && value.includes(',') ? `"${value}"` : value;
                    });
                });

                return [headers, ...rows].map(row => row.join(',')).join('\n');
            }

            getSelectedFields() {
                const fieldIds = ['company_name', 'company_type', 'location', 'region', 'total_headcount', 'revenue', 'glassdoor_rating'];
                return fieldIds.filter(fieldId => {
                    const checkbox = document.getElementById(`include_${fieldId}`);
                    return checkbox && checkbox.checked;
                });
            }

            showStatus(type, message) {
                const status = document.getElementById('status');
                status.className = `status ${type}`;
                status.style.display = 'block';
                document.getElementById('statusText').textContent = message;
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            if (typeof XLSX === 'undefined') {
                alert('XLSX library failed to load. Please refresh.');
                return;
            }
            window.companyResearcher = new CompanyResearcher();
        });
    </script>
</body>
</html>
