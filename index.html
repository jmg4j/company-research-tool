<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Company Research Tool</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh; padding: 20px;
        }
        .container {
            max-width: 1000px; margin: 0 auto; background: white;
            border-radius: 16px; box-shadow: 0 20px 40px rgba(0,0,0,0.1); overflow: hidden;
        }
        .header {
            background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
            color: white; padding: 40px; text-align: center;
        }
        .header h1 { font-size: 2.5em; margin-bottom: 10px; font-weight: 700; }
        .header p { font-size: 1.2em; opacity: 0.9; }
        .main-content { padding: 40px; }
        .section { margin-bottom: 40px; }
        .section h2 {
            font-size: 1.8em; margin-bottom: 20px; color: #1f2937;
            border-bottom: 3px solid #4f46e5; padding-bottom: 10px;
        }
        .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 25px; }
        .form-group { display: flex; flex-direction: column; }
        .form-group label { font-weight: 600; margin-bottom: 8px; color: #374151; }
        .form-group input, .form-group select {
            padding: 12px 16px; border: 2px solid #e5e7eb; border-radius: 8px;
            font-size: 16px; background: white;
        }
        .upload-section {
            border: 3px dashed #d1d5db; border-radius: 12px; padding: 40px;
            text-align: center; background: #f9fafb; cursor: pointer;
        }
        .upload-section:hover { border-color: #4f46e5; background: #f3f4f6; }
        .file-info {
            margin-top: 20px; padding: 16px; background: #ecfdf5;
            border: 2px solid #10b981; border-radius: 8px; color: #065f46;
        }
        .process-btn {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white; padding: 16px 32px; border: none; border-radius: 12px;
            font-size: 1.1em; cursor: pointer; width: 100%; margin-top: 30px;
        }
        .process-btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .status { margin-top: 20px; padding: 16px; border-radius: 8px; display: none; }
        .status.success { background: #ecfdf5; border: 2px solid #10b981; color: #065f46; }
        .status.error { background: #fef2f2; border: 2px solid #ef4444; color: #991b1b; }
        .status.processing { background: #fffbeb; border: 2px solid #f59e0b; color: #92400e; }
        .quick-btn { background: #4f46e5; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; margin: 5px; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üîç Company Research Tool</h1>
            <p>Automated competitive intelligence research powered by AI</p>
        </div>
        <div class="main-content">
            <div style="background: #fef3c7; border: 2px solid #f59e0b; color: #92400e; padding: 16px; border-radius: 8px; margin-bottom: 20px;">
                <strong>‚ö†Ô∏è Important:</strong> Upload max 20 companies. API costs covered - use responsibly!
            </div>
            
            <div class="section">
                <h2>‚öôÔ∏è Configuration</h2>
                <div class="form-grid">
                    <div class="form-group">
                        <label for="outputFileName">Output File Name</label>
                        <input type="text" id="outputFileName" value="research_results">
                    </div>
                </div>
            </div>

            <div class="section">
                <h2>üìä Data Output Configuration</h2>
                <p style="color: #6b7280; margin-bottom: 20px; font-style: italic;">
                    The AI will research all these data points for each company. Check the boxes for fields you want included in your output CSV:
                </p>
                
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); gap: 25px;">
                    
                    <!-- Basic Company Info -->
                    <div style="background: #f8fafc; border: 2px solid #e2e8f0; border-radius: 12px; padding: 20px;">
                        <h4 style="color: #1f2937; margin-bottom: 15px; font-weight: 600; display: flex; align-items: center;">
                            üè¢ <span style="margin-left: 8px;">Basic Company Information</span>
                        </h4>
                        <div>
                            <label style="display: flex; align-items: center; margin-bottom: 8px; cursor: pointer; font-size: 0.9em; color: #4b5563;">
                                <input type="checkbox" id="include_company_name" checked disabled style="margin-right: 8px;">
                                <span><strong>Company Name</strong> - Company name (always included)</span>
                            </label>
                            <label style="display: flex; align-items: center; margin-bottom: 8px; cursor: pointer; font-size: 0.9em; color: #4b5563;">
                                <input type="checkbox" id="include_company_type" checked style="margin-right: 8px;">
                                <span><strong>Company Type</strong> - Public, Private, Startup, Nonprofit, Unknown</span>
                            </label>
                            <label style="display: flex; align-items: center; margin-bottom: 8px; cursor: pointer; font-size: 0.9em; color: #4b5563;">
                                <input type="checkbox" id="include_location" checked style="margin-right: 8px;">
                                <span><strong>Location</strong> - US headquarters state</span>
                            </label>
                            <label style="display: flex; align-items: center; margin-bottom: 8px; cursor: pointer; font-size: 0.9em; color: #4b5563;">
                                <input type="checkbox" id="include_region" checked style="margin-right: 8px;">
                                <span><strong>Region</strong> - East, Midwest, West, Southern, International</span>
                            </label>
                        </div>
                    </div>
            
                    <!-- Employee Metrics -->
                    <div style="background: #f8fafc; border: 2px solid #e2e8f0; border-radius: 12px; padding: 20px;">
                        <h4 style="color: #1f2937; margin-bottom: 15px; font-weight: 600; display: flex; align-items: center;">
                            üë• <span style="margin-left: 8px;">Employee Metrics</span>
                        </h4>
                        <div>
                            <label style="display: flex; align-items: center; margin-bottom: 8px; cursor: pointer; font-size: 0.9em; color: #4b5563;">
                                <input type="checkbox" id="include_total_headcount" checked style="margin-right: 8px;">
                                <span><strong>Total Headcount</strong> - Global employee count</span>
                            </label>
                            <label style="display: flex; align-items: center; margin-bottom: 8px; cursor: pointer; font-size: 0.9em; color: #4b5563;">
                                <input type="checkbox" id="include_us_headcount" checked style="margin-right: 8px;">
                                <span><strong>US Headcount</strong> - US-based employee count</span>
                            </label>
                            <label style="display: flex; align-items: center; margin-bottom: 8px; cursor: pointer; font-size: 0.9em; color: #4b5563;">
                                <input type="checkbox" id="include_employee_growth_3yr" checked style="margin-right: 8px;">
                                <span><strong>Employee Growth (3yr)</strong> - Annual growth rate percentage</span>
                            </label>
                            <label style="display: flex; align-items: center; margin-bottom: 8px; cursor: pointer; font-size: 0.9em; color: #4b5563;">
                                <input type="checkbox" id="include_median_manager_salary" style="margin-right: 8px;">
                                <span><strong>Median Manager Salary</strong> - US manager salary in thousands</span>
                            </label>
                        </div>
                    </div>
            
                    <!-- Financial Data -->
                    <div style="background: #f8fafc; border: 2px solid #e2e8f0; border-radius: 12px; padding: 20px;">
                        <h4 style="color: #1f2937; margin-bottom: 15px; font-weight: 600; display: flex; align-items: center;">
                            üí∞ <span style="margin-left: 8px;">Financial Data</span>
                        </h4>
                        <div>
                            <label style="display: flex; align-items: center; margin-bottom: 8px; cursor: pointer; font-size: 0.9em; color: #4b5563;">
                                <input type="checkbox" id="include_revenue" checked style="margin-right: 8px;">
                                <span><strong>Revenue</strong> - Annual revenue in millions USD</span>
                            </label>
                            <label style="display: flex; align-items: center; margin-bottom: 8px; cursor: pointer; font-size: 0.9em; color: #4b5563;">
                                <input type="checkbox" id="include_revenue_growth_3yr" checked style="margin-right: 8px;">
                                <span><strong>Revenue Growth (3yr)</strong> - Annual revenue growth rate percentage</span>
                            </label>
                        </div>
                    </div>
            
                    <!-- Culture & Workplace -->
                    <div style="background: #f8fafc; border: 2px solid #e2e8f0; border-radius: 12px; padding: 20px;">
                        <h4 style="color: #1f2937; margin-bottom: 15px; font-weight: 600; display: flex; align-items: center;">
                            üéØ <span style="margin-left: 8px;">Culture & Workplace (1-5 ratings)</span>
                        </h4>
                        <div>
                            <label style="display: flex; align-items: center; margin-bottom: 8px; cursor: pointer; font-size: 0.9em; color: #4b5563;">
                                <input type="checkbox" id="include_glassdoor_rating" checked style="margin-right: 8px;">
                                <span><strong>Glassdoor Rating</strong> - Employee satisfaction (1.0-5.0)</span>
                            </label>
                            <label style="display: flex; align-items: center; margin-bottom: 8px; cursor: pointer; font-size: 0.9em; color: #4b5563;">
                                <input type="checkbox" id="include_culture_signals" style="margin-right: 8px;">
                                <span><strong>Culture Signals</strong> - Company culture strength</span>
                            </label>
                            <label style="display: flex; align-items: center; margin-bottom: 8px; cursor: pointer; font-size: 0.9em; color: #4b5563;">
                                <input type="checkbox" id="include_learning_programs" style="margin-right: 8px;">
                                <span><strong>Learning Programs</strong> - L&D and training quality</span>
                            </label>
                            <label style="display: flex; align-items: center; margin-bottom: 8px; cursor: pointer; font-size: 0.9em; color: #4b5563;">
                                <input type="checkbox" id="include_awards_recognition" style="margin-right: 8px;">
                                <span><strong>Awards & Recognition</strong> - Industry awards and recognition</span>
                            </label>
                            <label style="display: flex; align-items: center; margin-bottom: 8px; cursor: pointer; font-size: 0.9em; color: #4b5563;">
                                <input type="checkbox" id="include_manager_coaching" style="margin-right: 8px;">
                                <span><strong>Manager Coaching</strong> - Leadership development programs</span>
                            </label>
                        </div>
                    </div>
            
                    <!-- Research Metadata -->
                    <div style="background: #f8fafc; border: 2px solid #e2e8f0; border-radius: 12px; padding: 20px;">
                        <h4 style="color: #1f2937; margin-bottom: 15px; font-weight: 600; display: flex; align-items: center;">
                            üîç <span style="margin-left: 8px;">Research Metadata</span>
                        </h4>
                        <div>
                            <label style="display: flex; align-items: center; margin-bottom: 8px; cursor: pointer; font-size: 0.9em; color: #4b5563;">
                                <input type="checkbox" id="include_research_summary" checked style="margin-right: 8px;">
                                <span><strong>Research Summary</strong> - What sources were found</span>
                            </label>
                            <label style="display: flex; align-items: center; margin-bottom: 8px; cursor: pointer; font-size: 0.9em; color: #4b5563;">
                                <input type="checkbox" id="include_data_quality" checked style="margin-right: 8px;">
                                <span><strong>Data Quality</strong> - High, Medium, Low confidence</span>
                            </label>
                            <label style="display: flex; align-items: center; margin-bottom: 8px; cursor: pointer; font-size: 0.9em; color: #4b5563;">
                                <input type="checkbox" id="include_sources_found" style="margin-right: 8px;">
                                <span><strong>Sources Found</strong> - Number of sources used</span>
                            </label>
                        </div>
                    </div>
            
                    <!-- Quick Actions -->
                    <div style="background: #eef2ff; border: 2px solid #4f46e5; border-radius: 12px; padding: 20px;">
                        <h4 style="color: #1f2937; margin-bottom: 15px; font-weight: 600; display: flex; align-items: center;">
                            ‚ö° <span style="margin-left: 8px;">Quick Actions</span>
                        </h4>
                        <div style="display: flex; flex-direction: column; gap: 10px;">
                            <button onclick="selectAllFields()" class="quick-btn" style="background: #4f46e5;">
                                ‚úÖ Select All Fields
                            </button>
                            <button onclick="selectEssentialFields()" class="quick-btn" style="background: #10b981;">
                                üéØ Essential Fields Only
                            </button>
                            <button onclick="selectCultureFields()" class="quick-btn" style="background: #f59e0b;">
                                üé® Culture Focus
                            </button>
                        </div>
                    </div>
            
                </div>
            </div>

            <div class="section">
                <h2>üìÑ Upload Companies</h2>
                <div class="upload-section" id="uploadSection" onclick="document.getElementById('fileInput').click()">
                    <div style="font-size: 3em; margin-bottom: 16px;">üìä</div>
                    <div style="font-size: 1.2em; color: #6b7280; margin-bottom: 16px;">
                        Click to upload CSV/Excel file
                    </div>
                    <input type="file" id="fileInput" accept=".csv,.xlsx,.xls" style="display: none;">
                </div>
                <div id="fileInfo" class="file-info" style="display: none;"></div>
            </div>

            <button id="processBtn" class="process-btn" disabled>üöÄ Start Research</button>
            <div id="status" class="status"><div id="statusText"></div></div>
            <div id="resultsSection" style="margin-top: 30px; display: none;">
                <h2>‚úÖ Complete!</h2>
                <a id="downloadBtn" style="background: #7c3aed; color: white; padding: 14px 28px; border-radius: 10px; text-decoration: none; display: inline-block; margin-top: 10px;">üì• Download</a>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script>
function selectAllFields() {
            document.querySelectorAll('input[type="checkbox"][id^="include_"]:not([disabled])').forEach(cb => cb.checked = true);
        }

        function selectEssentialFields() {
            document.querySelectorAll('input[type="checkbox"][id^="include_"]:not([disabled])').forEach(cb => cb.checked = false);
            ['company_name', 'company_type', 'location', 'revenue', 'glassdoor_rating'].forEach(field => {
                const checkbox = document.getElementById(`include_${field}`);
                if (checkbox) checkbox.checked = true;
            });
        }
        function selectCultureFields() {
            document.querySelectorAll('input[type="checkbox"][id^="include_"]:not([disabled])').forEach(cb => cb.checked = false);
            ['company_name', 'glassdoor_rating', 'culture_signals', 'learning_programs', 'awards_recognition', 'manager_coaching', 'data_quality'].forEach(field => {
                const checkbox = document.getElementById(`include_${field}`);
                if (checkbox) checkbox.checked = true;
            });
        }
        class CompanyResearcher {
            constructor() {
                this.companies = [];
                this.results = [];
                this.isProcessing = false;
                this.initializeEventListeners();
            }

            initializeEventListeners() {
                document.getElementById('fileInput').addEventListener('change', this.handleFileSelect.bind(this));
                document.getElementById('processBtn').addEventListener('click', this.startResearch.bind(this));
            }

            handleFileSelect(e) {
                const file = e.target.files[0];
                if (file) this.processFile(file);
            }

            async processFile(file) {
                try {
                    const companies = await this.parseFile(file);
                    if (companies.length > 20) {
                        this.showStatus('error', '‚ùå Too many companies! Limit to 20.');
                        return;
                    }
                    this.companies = companies;
                    document.getElementById('fileInfo').style.display = 'block';
                    document.getElementById('fileInfo').innerHTML = `
                        <strong>‚úÖ Success!</strong><br>
                        Found ${companies.length} companies: ${companies.slice(0, 5).join(', ')}${companies.length > 5 ? '...' : ''}
                    `;
                    document.getElementById('processBtn').disabled = false;
                } catch (error) {
                    this.showStatus('error', `‚ùå Error: ${error.message}`);
                }
            }

            async parseFile(file) {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        try {
                            const data = new Uint8Array(e.target.result);
                            const workbook = XLSX.read(data, { type: 'array' });
                            const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                            const jsonData = XLSX.utils.sheet_to_json(firstSheet, { header: 1 });
                            const companies = jsonData.slice(1)
                                .map(row => row[0])
                                .filter(company => company && typeof company === 'string')
                                .map(company => company.trim());
                            resolve(companies);
                        } catch (error) {
                            reject(error);
                        }
                    };
                    reader.onerror = () => reject(new Error('Failed to read file'));
                    reader.readAsArrayBuffer(file);
                });
            }

            async startResearch() {
                if (this.isProcessing) return;
                this.isProcessing = true;
                this.results = [];
                document.getElementById('processBtn').disabled = true;
                document.getElementById('resultsSection').style.display = 'none';
                this.showStatus('processing', `üîç Researching ${this.companies.length} companies...`);

                for (let i = 0; i < this.companies.length; i++) {
                    const company = this.companies[i];
                    try {
                        const result = await this.researchCompany(company);
                        this.results.push(result);
                        this.showStatus('processing', `‚úÖ ${company} complete (${i + 1}/${this.companies.length})`);
                        if (i < this.companies.length - 1) {
                            await new Promise(resolve => setTimeout(resolve, 3000));
                        }
                    } catch (error) {
                        console.error(`Error researching ${company}:`, error);
                        this.results.push(this.createErrorResult(company, error.message));
                    }
                }
                this.completeResearch();
            }

            async researchCompany(companyName) {
const systemPrompt = `You are a competitive intelligence analyst. Research companies using web search.

        CRITICAL INSTRUCTIONS:
        1. You MUST use web_search tool multiple times for EACH company
        2. Search for: "${companyName} employees", "${companyName} revenue", "${companyName} glassdoor"
        3. Use web_fetch to get detailed info from company websites
        4. NEVER return -1 or "Unknown" - always provide reasonable estimates
        
        For ratings (1-5 scale):
        - culture_signals: Based on employee reviews and company initiatives
        - learning_programs: Based on L&D mentions, training programs
        - awards_recognition: Based on industry awards, best workplace lists
        - manager_coaching: Based on leadership development programs
            
            Return JSON with this EXACT structure:
            {
              "company_name": "string",
              "location": "US state only",
              "company_type": "Public|Private|Startup|Nonprofit|Unknown",
              "region": "East|Midwest|West|Southern|International|Unknown",
              "total_headcount": integer,
              "us_headcount": integer,
              "revenue": integer,
              "revenue_growth_3yr": number,
              "employee_growth_3yr": number,
              "median_manager_salary": integer,
              "glassdoor_rating": number,
              "culture_signals": number,
              "learning_programs": number,
              "awards_recognition": number,
              "manager_coaching": number,
              "research_summary": "what you found and sources",
              "sources_found": integer,
              "data_quality": "High|Medium|Low"
            }`;
                const userPrompt = `Research this company: ${companyName}

Use multiple web searches. Find actual data. Estimate when needed.`;

                const response = await fetch('/.netlify/functions/research', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        messages: [
                            { role: 'system', content: systemPrompt },
                            { role: 'user', content: userPrompt }
                        ],
                        model: 'sonar-reasoning-pro'
                    })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(`API failed: ${response.status} - ${errorData.error || 'Unknown'}`);
                }

                const data = await response.json();
                console.log('API Response:', data);
                return this.parseApiResponse(data, companyName);
            }

            parseApiResponse(apiData, companyName) {
                try {
                    if (!apiData.choices || !apiData.choices[0]) {
                        throw new Error('Invalid API response structure');
                    }
                    const content = apiData.choices[0].message.content.trim();
                    const jsonStart = content.indexOf('{');
                    const jsonEnd = content.lastIndexOf('}') + 1;
                    
                    if (jsonStart === -1 || jsonEnd <= jsonStart) {
                        throw new Error('No valid JSON found');
                    }
                    
                    const jsonStr = content.substring(jsonStart, jsonEnd);
                    const data = JSON.parse(jsonStr);
                    return this.validateData(data, companyName);
                } catch (error) {
                    throw new Error(`Parse failed: ${error.message}`);
                }
            }

            validateData(data, companyName) {
                return {
                    company_name: data.company_name || companyName,
                    location: data.location || 'Unknown',
                    company_type: data.company_type || 'Unknown',
                    region: this.mapRegion(data.location),
                    total_headcount: Math.max(1, parseInt(data.total_headcount) || 1),
                    us_headcount: Math.max(1, parseInt(data.us_headcount) || Math.floor((parseInt(data.total_headcount) || 1) * 0.8)),
                    revenue: Math.max(1, parseInt(data.revenue) || 1),
                    revenue_growth_3yr: parseFloat(data.revenue_growth_3yr) || 12,
                    employee_growth_3yr: parseFloat(data.employee_growth_3yr) || 15,
                    median_manager_salary: Math.max(60, parseInt(data.median_manager_salary) || 85),
                    glassdoor_rating: Math.max(1, Math.min(5, parseFloat(data.glassdoor_rating) || 3.5)),
                    culture_signals: Math.max(1, Math.min(5, parseInt(data.culture_signals) || 3)),
                    learning_programs: Math.max(1, Math.min(5, parseInt(data.learning_programs) || 3)),
                    awards_recognition: Math.max(1, Math.min(5, parseInt(data.awards_recognition) || 3)),
                    manager_coaching: Math.max(1, Math.min(5, parseInt(data.manager_coaching) || 3)),
                    research_summary: data.research_summary || 'Basic research completed',
                    sources_found: Math.max(0, parseInt(data.sources_found) || 0),
                    data_quality: data.data_quality || 'Medium'
                };
            }

            mapRegion(location) {
                if (!location) return 'Unknown';
                const locationUpper = location.toUpperCase();
                
                const regions = {
                    'West': ['CA', 'WA', 'OR', 'CO', 'AZ', 'NV', 'UT', 'CALIFORNIA', 'WASHINGTON', 'OREGON', 'COLORADO', 'ARIZONA', 'NEVADA', 'UTAH'],
                    'East': ['CT', 'DE', 'ME', 'MA', 'NH', 'NJ', 'NY', 'VT', 'PA', 'CONNECTICUT', 'DELAWARE', 'MAINE', 'MASSACHUSETTS', 'NEW HAMPSHIRE', 'NEW JERSEY', 'NEW YORK', 'VERMONT', 'PENNSYLVANIA'],
                    'Southern': ['TX', 'FL', 'GA', 'NC', 'VA', 'TN', 'SC', 'TEXAS', 'FLORIDA', 'GEORGIA', 'NORTH CAROLINA', 'VIRGINIA', 'TENNESSEE', 'SOUTH CAROLINA'],
                    'Midwest': ['IL', 'IN', 'IA', 'KS', 'MI', 'MN', 'OH', 'WI', 'ILLINOIS', 'INDIANA', 'IOWA', 'KANSAS', 'MICHIGAN', 'MINNESOTA', 'OHIO', 'WISCONSIN']
                };
                
                for (const [region, states] of Object.entries(regions)) {
                    if (states.some(state => locationUpper.includes(state))) {
                        return region;
                    }
                }
                return 'Unknown';
            }

            createErrorResult(companyName, errorMsg) {
                return {
                    company_name: companyName,
                    location: 'Unknown',
                    company_type: 'Unknown',
                    region: 'Unknown',
                    total_headcount: 1,
                    revenue: 1,
                    glassdoor_rating: 3,
                    research_summary: `Failed: ${errorMsg}`,
                    sources_found: 0,
                    data_quality: 'Low'
                };
            }

            completeResearch() {
                this.isProcessing = false;
                document.getElementById('processBtn').disabled = false;
                this.showStatus('success', '‚úÖ Research completed!');

                const csv = this.generateCSV();
                const blob = new Blob([csv], { type: 'text/csv' });
                const url = URL.createObjectURL(blob);
                
                const fileName = document.getElementById('outputFileName').value.trim() || 'research_results';
                const dateStamp = new Date().toISOString().split('T')[0];
                const finalFileName = `${fileName}_${dateStamp}.csv`;
                
                const downloadBtn = document.getElementById('downloadBtn');
                downloadBtn.href = url;
                downloadBtn.download = finalFileName;
                downloadBtn.innerHTML = `üì• Download ${finalFileName}`;
                
                document.getElementById('resultsSection').style.display = 'block';
            }

            generateCSV() {
                const selectedFields = this.getSelectedFields();
                const fieldMapping = {
                    'company_name': 'Company Name',
                    'company_type': 'Company Type',
                    'location': 'Location',
                    'region': 'Region',
                    'total_headcount': 'Total Headcount',
                    'us_headcount': 'US Headcount',
                    'revenue': 'Revenue',
                    'revenue_growth_3yr': 'Revenue Growth 3yr',
                    'employee_growth_3yr': 'Employee Growth 3yr',
                    'median_manager_salary': 'Median Manager Salary',
                    'glassdoor_rating': 'Glassdoor Rating',
                    'culture_signals': 'Culture Signals',
                    'learning_programs': 'Learning Programs',
                    'awards_recognition': 'Awards Recognition',
                    'manager_coaching': 'Manager Coaching',
                    'research_summary': 'Research Summary',
                    'data_quality': 'Data Quality',
                    'sources_found': 'Sources Found'
                };
                const headers = selectedFields.map(field => fieldMapping[field]);
                const rows = this.results.map(result => {
                    return selectedFields.map(field => {
                        const value = result[field];
                        return typeof value === 'string' && value.includes(',') ? `"${value}"` : value;
                    });
                });

                return [headers, ...rows].map(row => row.join(',')).join('\n');
            }

            getSelectedFields() {
                const fieldIds = [
    'company_name', 'company_type', 'location', 'region', 'total_headcount', 
    'us_headcount', 'revenue', 'revenue_growth_3yr', 'employee_growth_3yr', 
    'median_manager_salary', 'glassdoor_rating', 'culture_signals', 
    'learning_programs', 'awards_recognition', 'manager_coaching',
    'research_summary', 'data_quality', 'sources_found'
];
                return fieldIds.filter(fieldId => {
                    const checkbox = document.getElementById(`include_${fieldId}`);
                    return checkbox && checkbox.checked;
                });
            }

            showStatus(type, message) {
                const status = document.getElementById('status');
                status.className = `status ${type}`;
                status.style.display = 'block';
                document.getElementById('statusText').textContent = message;
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            if (typeof XLSX === 'undefined') {
                alert('XLSX library failed to load. Please refresh.');
                return;
            }
            window.companyResearcher = new CompanyResearcher();
        });
    </script>
</body>
</html>
